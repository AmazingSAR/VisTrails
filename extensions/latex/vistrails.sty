%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% Copyright (C) 2006-2008 University of Utah. All rights reserved.
%%
%% This file is part of VisTrails.
%%
%% This file may be used under the terms of the GNU General Public
%% License version 2.0 as published by the Free Software Foundation
%% and appearing in the file LICENSE.GPL included in the packaging of
%% this file.  Please review the following to ensure GNU General Public
%% Licensing requirements will be met:
%% http://www.opensource.org/licenses/gpl-license.php
%%
%% If you are unsure which license is appropriate for your use (for
%% instance, you are interested in developing a commercial derivative
%% of VisTrails), please contact us at vistrails@sci.utah.edu.
%%
%% This file is provided AS IS with NO WARRANTY OF ANY KIND, INCLUDING THE
%% WARRANTY OF DESIGN, MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Note: shell-escape needs to be activated for this to work.
%% This can either be done by passing -shell-escape as an option to
%% latex or by adding/changing "shell_escape = t" in your texmf.cnf .

\NeedsTeXFormat{LaTeX2e}[1994/12/01]
\ProvidesPackage{vistrails}[2008/08/06 v0.1 VisTrails in LaTeX]

%% keyval package allows us to define arguments in a command as key-value pairs,
%%  which is more convenient

\RequirePackage{graphicx,keyval}

%% This is to hide the border of the included image
\RequirePackage[pdfborder={0 0 0}]{hyperref}

%% we will generate a file for pasing to python
\newwrite\pythonincludein

%% by default we will run vistrails on the web server
\newcommand{\vistrailspath}{http://www.vistrails.org/extensions/run_vistrails.php}

%% this is for allowing line breaks, empty values in vistrails command's options
\def\vistrail{\kernel@ifnextchar [{\@vistrail}{\@vistrail[]}}

\def\@vistrail[#1]#2{%
\immediate\openout\pythonincludein=\jobname.cmdline
\immediate\write\pythonincludein{path=\vistrailspath}
\setkeys{vt}{#1}
\ifx\@empty#2\@empty
    \immediate\write\pythonincludein{other=}
\else
    \immediate\write\pythonincludein{other=\string#2}
\fi
\immediate\closeout\pythonincludein
\immediate\write18{python includevistrail.py \jobname.cmdline > \jobname.cmdline.out 2> \jobname.cmdline.err}
\immediate\input\jobname.cmdline.out
}

%% key-value pairs for the command's options
\define@key{vt}{host}[vistrails.sci.utah.edu]{\immediate\write\pythonincludein{host=\string#1}}
\define@key{vt}{db}[vistrails]{\immediate\write\pythonincludein{db=\string#1}}
\define@key{vt}{vtid}{\immediate\write\pythonincludein{vtid=\string#1}}
\define@key{vt}{version}{\immediate\write\pythonincludein{version=\string#1}}
\define@key{vt}{tag}[]{\immediate\write\pythonincludein{tag=\string#1}}
\define@key{vt}{port}[3306]{\immediate\write\pythonincludein{port=\string#1}}
\define@key{vt}{buildalways}[true]{\immediate\write\pythonincludein{buildalways=\string#1}}
\define@key{vt}{execute}[true]{\immediate\write\pythonincludein{execute=\string#1}}
\define@key{vt}{showspreadsheetonly}[true]{\immediate\write\pythonincludein{showspreadsheetonly=\string#1}}


